var SETTINGS={MAPBOX:{pk:"pk.eyJ1Ijoib2xpdmVycm9pY2siLCJhIjoibElUMjV3SSJ9.4yqK1nshhmHKJawP6FMLmw"},FOURSQUARE:{client_id:"EYHTDELXEFC2JKH3ELWBW05U5FKNPI40T4RCDKLF4ZTJLHSR"}};!function(a){"use strict";var b,c={stroke:!1,fill:!0,fillColor:"#22313F",fillOpacity:.4},d={stroke:!0,color:"#F7CA18",opacity:1,fill:!0,fillColor:"#22313F",fillOpacity:1},e={stroke:!0,color:"#fff",opacity:1,fill:!0,fillColor:"#F7CA18",fillOpacity:1},f=L.featureGroup(),g=function(){L.mapbox.accessToken=SETTINGS.MAPBOX.pk,this.map=L.mapbox.map("map","mapbox.streets-basic",{zoomControl:!1}).setView([51.50719323477933,-.12754440307617188],9),this.map.on("click",function(){this.emitEvent("map:featureUnselect",b),this.unselectFeature()}.bind(this)),this.map.on("dragstart",function(){this.emitEvent("map:drag")}.bind(this)),this.map.on("zoomend",function(){b&&this.map.panTo(b.properties.location,{animate:!0})}.bind(this)),f.addTo(this.map)};g.prototype=new EventEmitter,g.constructor=g,g.prototype.unselectFeature=function(){b&&(b.setStyle(c),b=null)},g.prototype.addCheckins=function(a){for(var b in a){var d=a[b],e=L.circleMarker(d.location,c),g=d.checkins<=41?10+Math.floor(d.checkins/2):25;e.setRadius(g),e.properties=d,e.on("click",j.bind(this)),e.on("mouseover",i.bind(this)),e.on("mouseout",h),f.addLayer(e)}this.map.fitBounds(f.getBounds())};var h=function(a){a.target!==b?a.target.setStyle(c):a.target.setStyle(e)},i=function(a){a.target.setStyle(d),a.target.bringToFront()},j=function(a){b&&b.setStyle(c),b=a.target,a.target.setStyle(e),a.target.bringToFront();var d=this.map.getZoom()>14?this.map.getZoom():12;this.map.setView(a.target.properties.location,d),this.emitEvent("map:featureSelect",a.target)};a.map=new g}(window.views?window.views:window.views={}),function(a){"use strict";function b(){this.element=document.getElementById("authenticate");var a=document.getElementById("fs-auth").href;document.getElementById("fs-auth").href=a.replace("[token]",SETTINGS.FOURSQUARE.client_id)}b.prototype.show=function(){this.element.classList.remove("hidden")},a.authenticate=new b}(window.views?window.views:window.views={}),function(a){"use strict";function b(){this.element=document.getElementById("working"),this.head=this.element.getElementsByTagName("h2")[0],this.message=this.element.getElementsByTagName("p")[0]}b.prototype.show=function(a,b){this.head.innerHTML=a,this.message.innerHTML=b,this.element.classList.remove("hidden")},b.prototype.hide=function(){this.element.classList.add("hidden")},a.working=new b}(window.views?window.views:window.views={}),function(a){"use strict";function b(){this.element=document.getElementById("venue-info"),this.head=this.element.getElementsByTagName("h2")[0],this.checkins=this.element.getElementsByClassName("number")[0],this.closeBtn=this.element.getElementsByClassName("close-btn")[0],this.closeBtn.addEventListener("click",function(){this.hide(),this.emitEvent("window:closed")}.bind(this))}b.prototype=new EventEmitter,b.constructor=b,b.prototype.show=function(a,b){this.head.innerHTML=a,this.checkins.innerHTML=b+' <span class="label">Checkin'+(b>1?"s":"")+"</span>",this.element.classList.remove("hidden")},b.prototype.hide=function(){this.element.classList.add("hidden")},a.venueInfo=new b}(window.views?window.views:window.views={}),function(a){"use strict";function b(){this.token=null,this.page=0,this.checkins=[]}b.prototype=new EventEmitter,b.constructor=b,b.prototype.isAuthorizsed=function(){return-1!==document.URL.indexOf("#")&&document.URL.split("#")[1].startsWith("access_token=")&&(this.token=document.URL.split("#")[1].split("=")[1]),null!==this.token},b.prototype.storeCheckins=function(a){this.checkins=this.checkins.concat(a.response.checkins.items);var b=a.response.checkins.count;250*(this.page+1)>b?(this.emitEvent("checkins:loadend",{count:this.checkins.length}),this.processCheckins()):(this.page++,this.getCheckins())},b.prototype.getCheckins=function(){var a=250*this.page,b="https://api.foursquare.com/v2/users/self/checkins?limit=250&offset="+a+"&oauth_token="+this.token+"&v=20140401",c=document.createElement("script");c.src=b+"&callback=Foursquare.storeCheckins",document.body.appendChild(c)},b.prototype.processCheckins=function(){for(var a={},b=0,c=this.checkins.length;c>b;b++){var d=this.checkins[b].venue;d&&(void 0!==a[d.id]?a[d.id].checkins++:a[d.id]={id:d.id,name:d.name,category:d.categories[0],checkins:1,location:[d.location.lat,d.location.lng]})}this.emitEvent("checkins:processed",{checkins:a})},a.Foursquare=new b}(window),function(a){"use strict";function b(){Foursquare.isAuthorizsed()?(views.working.show("Loading","We are getting your checkin data from Foursquare."),Foursquare.registerListener("checkins:loadend",c),Foursquare.registerListener("checkins:processed",d),Foursquare.getCheckins()):views.authenticate.show()}var c=function(a){views.working.hide(),views.working.show("Processing checkins","We are processing "+a.count+" checkins now.")},d=function(a){views.working.hide(),views.map.addCheckins(a.checkins),views.map.registerListener("map:featureSelect",e),views.map.registerListener("map:featureUnselect",f),views.map.registerListener("map:drag",f),views.venueInfo.registerListener("window:closed",f)},e=function(a){views.venueInfo.show(a.properties.name,a.properties.checkins)},f=function(a){views.venueInfo.hide(),views.map.unselectFeature()};a.app=new b}(window);